<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<!-- 
* @Project  : 자본시장 공동 핀테크 오픈플랫폼 구축
* @FileName : AppDAO.java
* @Comment  : [앱신청] 앱관리를 위한 SQL XML
* @author   : 포털 김충열
* @since    : 2017.06.15
* @version  : 1.0
* @see
*
* << 개정이력(Modification Information) >>
* 수정일                  수정자        수정내용
* 2017.06.15   김충열        최초생성
-->

<sqlMap namespace="kr.co.koscom.oppf.spt.usr.svcAppl.service.impl.AppDAO">
       
    <!-- 서비스신청 -->
    <typeAlias alias="AppVO" type="kr.co.koscom.oppf.spt.usr.svcAppl.service.AppVO"/>
    <typeAlias alias="AppAccountVO" type="kr.co.koscom.oppf.spt.usr.svcAppl.service.AppAccountVO"/>
    <typeAlias alias="TermsVO" type="kr.co.koscom.oppf.spt.usr.svcAppl.service.TermsVO"/>
    <typeAlias alias="TermsPubCompanyVO" type="kr.co.koscom.oppf.spt.usr.svcAppl.service.TermsPubCompanyVO"/>

    <sql id="appListWhere">
        <!-- app 구분 -->
        <isNotEmpty property="searchAppCategory" prepend="and">
            a.app_category = #searchAppCategory#
        </isNotEmpty>
        <!-- app 신청완료 구분 -->
        <isEqual property="searchAppCreatedYn" compareValue="Y">
            and b.app_id is not null
        </isEqual>
        <!-- 검색어 -->
        <isNotEmpty property="searchKeyword">
			and
                (
                <!-- app명 -->
                a.app_name like concat('%', #searchKeyword#, '%') or
                <!-- 기업명 -->   
                a.company_name_kor_alias like concat('%', #searchKeyword#, '%') or 
                <!-- 앱 카테고리 --> 
				a.app_category_name like concat('%', #searchKeyword#, '%') or
				<!-- 연계서비스 금융투자회사명 -->	
				a.app_id IN(	
                            select
                                    a.app_id                                                                           
                            from
                                (select
                                        a.app_id,
                                        a.api_id,
                                        b.api_title,
                                        b.company_code_id,
                                        b.exposure_order
                                from  (
										select 	app_id,
                                                api_id 
                                        from 	com_app_apilist_view)a, com_api_info b
                                        where 	 a.api_id = b.api_id
										and	 	 b.exposure_yn='Y'
                                        and 	 b.api_account_yn='Y'
										) a
                                JOIN  com_company_profile AS b
                                  ON  a.company_code_id = b.company_code_id
                                 AND  b.delete_date IS NULL
                                 AND  b.exposure_yn = 'Y'
                                 AND  b.company_name_kor_alias  like concat('%', #searchKeyword#, '%')
                            ORDER BY  a.app_id, a.company_code_id, a.exposure_order
                  			)
                )
        </isNotEmpty>
    </sql>

    <select id="usr.AppDAO.selectAppListTotalCount" parameterClass="AppVO" resultClass="int">
        SELECT
                count(1) as cnt
        FROM
        (
            SELECT
                    a.app_id,
                    a.app_name,
                    a.a.app_status,
                    a.company_code_id,
                    b.company_name_kor_alias,
                    a.app_category ,
                    (
                        SELECT  code_name_kor
                        FROM    com_system_code
                        WHERE concat(system_grp_code, system_code) = a.app_category) AS app_category_name,
                    a.app_description,
                    a.exposure_order
            FROM
                (
                    SELECT
                            a.app_id,
                            a.app_name,
                            a.company_code_id,
                            a.a.app_status,
                            b.app_category,
                            b.app_description,
                            b.exposure_order
                    FROM   	com_app_view a JOIN com_app_info b ON a.app_id = b.app_id
                    JOIN (
                            SELECT a.app_id as app_id
                            FROM   (
                                        SELECT app_id,
                                                api_id
                                        FROM   com_app_apilist_view) a,
                                    com_api_info b
                            WHERE  a.api_id = b.api_id
                            AND    b.exposure_yn = 'Y'
                            AND    b.api_account_yn = 'Y'
                            group by a.app_id) c
                    ON c.app_id = a.app_id
                    WHERE  	a.app_status = 'G022002'                     /*app 상태 (CA 정보)*/
                    AND    	b.exposure_yn = 'Y') a
            JOIN com_company_profile AS b
            ON   a.company_code_id = b.company_code_id
            AND  b.delete_date IS NULL
            AND  b.exposure_yn = 'Y' ) a
        LEFT OUTER JOIN
        (
            select 	a.app_id,
                        a.create_date,
                        b.terms_expire_date
            from 	spt_customer_service_profile a,
                    spt_customer_service_terms_profile b
            where 	a.customer_reg_no = b.customer_reg_no
            and 	a.terms_reg_no = b.terms_reg_no
            and 	a.customer_reg_no = #customerRegNo#
            and 	a.delete_date is null
            and 	a.terms_reg_no is not null
            and 	b.terms_auth_yn = 'N') b
        ON b.app_id = a.app_id
        where 1=1
        <include refid="appListWhere"/>
    </select>

    <select id="usr.AppDAO.selectAppList" parameterClass="AppVO" resultClass="AppVO">
        SELECT
                a.app_id  AS appId,
                a.app_name AS appName,
                a.app_status AS appStatus,
                a.company_code_id AS companyCodeId,
                a.company_name_kor_alias AS companyName,
                a.app_category AS appCategory,
                a.app_category_name AS appCategoryName,
                a.app_description AS appDescription,
                case when isnull(b.app_id) then 2 else 1 end AS sort
        FROM
        (
            SELECT
                    a.app_id,
                    a.app_name,
                    a.a.app_status,
                    a.company_code_id,
                    b.company_name_kor_alias,
                    a.app_category ,
                    (
                      SELECT code_name_kor
                      FROM com_system_code
                      WHERE concat(system_grp_code, system_code) = a.app_category) AS app_category_name,
                    a.app_description,
                    a.exposure_order
            FROM
            (
                SELECT
                        a.app_id,
                        a.app_name,
                        a.company_code_id,
                        a.a.app_status,
                        b.app_category,
                        b.app_description,
                        b.exposure_order
                FROM   	com_app_view a JOIN com_app_info b ON a.app_id = b.app_id
                JOIN (
                        SELECT a.app_id as app_id
                        FROM   (
                                    SELECT app_id,
                                    api_id
                                    FROM   com_app_apilist_view) a,
                                com_api_info b
                        WHERE  a.api_id = b.api_id
                        AND    b.exposure_yn = 'Y'
                        AND    b.api_account_yn = 'Y'
                        group by a.app_id) c
                ON c.app_id = a.app_id
                WHERE  	a.app_status = 'G022002'                     /*app 상태 (CA 정보)*/
                AND    	b.exposure_yn = 'Y') a
            JOIN com_company_profile AS b
            ON   a.company_code_id = b.company_code_id
            AND  b.delete_date IS NULL
            AND  b.exposure_yn = 'Y' ) a
        LEFT OUTER JOIN
        (
            select 	a.app_id,
                        a.create_date,
                        b.terms_expire_date
            from 	spt_customer_service_profile a,
                    spt_customer_service_terms_profile b
            where 	a.customer_reg_no = b.customer_reg_no
            and 	a.terms_reg_no = b.terms_reg_no
            and 	a.customer_reg_no = #customerRegNo#
            and 	a.delete_date is null
            and 	a.terms_reg_no is not null
            and 	b.terms_auth_yn = 'N') b
        ON b.app_id = a.app_id
        where 1 = 1
        <include refid="appListWhere"/>
        order by a.exposure_order, a.app_name
        limit
        <isNotEmpty property="pageStart">#pageStart#</isNotEmpty>
        <isEmpty property="pageStart">0</isEmpty>
        <isNotEmpty property="pageRowsize">,#pageRowsize#</isNotEmpty>
        <isEmpty property="pageRowsize">,10</isEmpty>
    </select>

    <select id="usr.AppDAO.selectAppDetail" parameterClass="AppVO" resultClass="AppVO">
        SELECT
				a.app_id  AS appId,
				a.app_name AS appName,
				a.app_status AS appStatus,
				a.company_code_id AS companyCodeId,
				a.company_name_kor_alias AS companyName,
				a.app_category AS appCategory,
				a.app_category_name AS appCategoryName,
				a.app_description AS appDescription,
                ifnull(b.terms_reg_no, '') AS termsRegNo,
                ifnull(b.service_reg_no, '') AS serviceRegNo,
                ifnull(b.terms_start_date, '') AS termsStartDate,
                ifnull(b.terms_expire_date, '') AS termsEndDate,
                case when
					(date_format(sysdate(), '%Y%m%d') >= date_format(b.terms_expire_date - INTERVAL 1 MONTH, '%Y%m%d'))
					then
						'Y'
					else
						'N'
					end as reSyncYn
        FROM
        (
        SELECT
                        a.app_id,
                        a.app_name,
                        a.a.app_status,
                        a.company_code_id,
                        b.company_name_kor_alias,
                        a.app_category ,
                        (SELECT code_name_kor
                           FROM com_system_code
                          WHERE concat(system_grp_code, system_code) = a.app_category) AS app_category_name,
                        a.app_description,
                        a.exposure_order
                FROM
                (
                    SELECT
                            a.app_id,
                            a.app_name,
                            a.company_code_id,
                            a.a.app_status,
                            b.app_category,
                            b.app_description,
                            b.exposure_order
                    FROM   	com_app_view a JOIN com_app_info b ON a.app_id = b.app_id
            JOIN (SELECT a.app_id as app_id
                          FROM   (
                                  SELECT app_id,
                                         api_id
                                  FROM   com_app_apilist_view) a,
                                              com_api_info b
                          WHERE  a.api_id = b.api_id
                          AND    b.exposure_yn = 'Y'
                          AND    b.api_account_yn = 'Y'
                          group by a.app_id) c
            ON c.app_id = a.app_id
                    WHERE  	a.app_status = 'G022002'                     /*app 상태 (CA 정보)*/
                    AND    	b.exposure_yn = 'Y') a
                JOIN com_company_profile AS b
                ON   a.company_code_id = b.company_code_id
                AND  b.delete_date IS NULL
                AND  b.exposure_yn = 'Y' ) a
        LEFT OUTER JOIN
        (
                    select a.app_id,
                            a.create_date,
                            b.terms_expire_date,
                            a.service_reg_no,
                            a.terms_reg_no,
                            b.terms_start_date
                    from 	spt_customer_service_profile a,
                            spt_customer_service_terms_profile b
                    where 	a.customer_reg_no = b.customer_reg_no
                    and 	a.terms_reg_no = b.terms_reg_no
                    and 	a.customer_reg_no = #customerRegNo#
                    and 	a.delete_date is null
                    and 	a.terms_reg_no is not null
                    and 	b.terms_auth_yn = 'N') b
        ON b.app_id = a.app_id
        where a.app_id = #appId#
    </select>

    <select id="usr.AppDAO.selectAppAccountList" parameterClass="AppVO" resultClass="AppAccountVO">
        select
                    a.app_id                                                       AS appId,
                    a.api_id                                                       AS apiId,
                    a.api_name                                                     AS apiName,
                    a.account_reg_no                                               AS accountRegNo,
                    a.customer_realaccount_no                                      AS customerRealAccountNo,
                    pub.company_name_kor_alias                                     AS pubCompanyName,
                    pub.company_code_id                                            AS pubcompanyCodeId,
                    b.customer_vtaccount_no                                        AS customerVtaccountNo,
                    b.customer_vtaccount_alias                                     AS customerVtaccountAlias,
                    (
                        SELECT  code_name_kor
                        FROM    com_system_code
                        WHERE concat(system_grp_code, system_code) = b.customer_realaccount_type) AS customerRealAccountTypeName
        from(
                select  a.*,
                        b.api_name,
                        c.company_code_id       as pubcompany_code_id,
                        c.exposure_order        as pubexposure_order
                from(
                        select  a.*,
                                b.app_name,
                                c.app_description,
                                c.app_category,
                                b.company_code_id   as subcompany_code_id,
                                c.exposure_order    as subexposure_order
                        from(
                                select  a.customer_reg_no,
                                        a.service_reg_no,
                                        a.app_id,
                                        b.api_id,
                                        b.customer_realaccount_no,
                                        b.account_reg_no,
                                        a.terms_reg_no,
                                        a.terms_auth_yn,
                                        a.terms_start_date,
                                        a.terms_expire_date,
                                        a.terms_auth_date_yn
                                from(
                                        select  a.*,
                                                b.terms_auth_yn,
                                                date_format(b.terms_start_date, '%Y-%m-%d') as terms_start_date,
                                                date_format(b.terms_expire_date, '%Y-%m-%d') as terms_expire_date,
                                                case when
                                                    date_format(sysdate(), '%Y%m%d') <![CDATA[ >= ]]> date_format(b.terms_expire_date - INTERVAL 1 MONTH, '%Y%m%d') AND
                                                    date_format(sysdate(), '%Y%m%d') <![CDATA[ <= ]]> date_format(b.terms_expire_date, '%Y%m%d')
                                                then 'N'
                                                else 'Y'
                                                end as terms_auth_date_yn
                                        from(
                                                select  customer_reg_no,
                                                        service_reg_no,
                                                        app_id,
                                                        terms_reg_no
                                                from spt_customer_service_profile
                                                where customer_reg_no = #customerRegNo#
                                                and terms_reg_no is not null
                                                and delete_date is null
                                              ) a
                                        left join spt_customer_service_terms_profile b
                                        on a.customer_reg_no = b.customer_reg_no
                                        and a.terms_reg_no = b.terms_reg_no
                                    ) a, spt_customer_service_account_profile b
                                where a.customer_reg_no = b.customer_reg_no
                                and a.service_reg_no = b.service_reg_no
                                and a.app_id = b.app_id
                                and b.delete_date is null
                            ) a
                        left join com_app_view b on a.app_id = b.app_id
                        left join com_app_info c on a.app_id = c.app_id
                        where b.app_status = 'G022002'        /*app 상태 (CA 정보)*/
                    ) a
                left join com_api_view b on a.api_id = b.api_id
                left join com_api_info c on a.api_id = c.api_id
                where 1=1 /*c.exposure_yn = 'Y'*/
                and c.api_account_yn = 'Y'
            ) a
        left join(
                select *
                from spt_customer_account_profile
                where customer_reg_no = #customerRegNo#
                and customer_vtaccount_status = 'G009002'
        ) b
        on a.pubcompany_code_id = b.company_code_id
        and a.customer_realaccount_no = b.customer_realaccount_no
        join com_company_profile as pub on a.pubcompany_code_id = pub.company_code_id and pub.delete_date is null /*and pub.exposure_yn = 'Y'*/
        join com_company_profile as sub on a.subcompany_code_id = sub.company_code_id and sub.delete_date is null /*and sub.exposure_yn = 'Y'*/
        WHERE a.app_id = #appId#
        order by
        ifnull(sub.exposure_order, 'Z') asc, sub.company_name_kor_alias asc,
        ifnull(a.subexposure_order, 'Z') asc, a.app_name asc,
        ifnull(pub.exposure_order, 'Z') asc, pub.company_name_kor_alias asc,
        ifnull(a.pubexposure_order, 'Z') asc,  a.api_name asc
    </select>

    <select id="usr.AppDAO.selectAppDeleteTargetTerms" parameterClass="AppVO" resultClass="AppVO">
        select  a.customer_reg_no	as customerRegNo,
				a.service_reg_no	as serviceRegNo,
				a.terms_reg_no		as termsRegNo,
				b.customer_id		as customerId
		from spt_customer_service_profile a, spt_customer_info_profile b
		where a.customer_reg_no = #customerRegNo#
		and a.app_id = #appId#
		and a.terms_reg_no is not null
		and a.delete_date is null
		and a.customer_reg_no = b.customer_reg_no
    </select>

    <select id="usr.AppDAO.selectAppCountForTerms" parameterClass="AppVO" resultClass="String">
        select app_id as appId
		  from spt_customer_service_profile
		 where terms_reg_no = #termsRegNo#
		   and customer_reg_no = #customerRegNo#
		   and delete_date is null
    </select>

    <update id="usr.AppDAO.deleteServiceProfile" parameterClass="AppVO">
        update spt_customer_service_profile
        set
            delete_date = sysdate(),
            update_date = sysdate(),
            update_id = #customerRegNo#
        where customer_reg_no = #customerRegNo#
        <isNotEmpty property="serviceRegNo">
            and service_reg_no = #serviceRegNo#
        </isNotEmpty>
        <isNotEmpty property="termsRegNo">
            and terms_reg_no = #termsRegNo#
        </isNotEmpty>
    </update>

    <insert id="usr.AppDAO.insertServiceProfileHist" parameterClass="AppVO">
        INSERT INTO spt_customer_service_profile_hist
        (
            customer_reg_no
            , service_reg_no
            , service_seq
            , app_id
            , terms_reg_no
            , delete_date
            , create_date
            , create_id
        )
        SELECT
            a.customer_reg_no
            , a.service_reg_no
            , ifnull((
                select ifnull(max(cast(service_seq as SIGNED)), 0) + 1
                from spt_customer_service_profile_hist
                where customer_reg_no = a.customer_reg_no
                and service_reg_no = a.service_reg_no
            ), 1)
            , a.app_id
            , a.terms_reg_no
            , a.delete_date
            , sysdate()
            , a.create_id
        FROM spt_customer_service_profile a
        WHERE a.customer_reg_no = #customerRegNo#
        <isNotEmpty property="serviceRegNo">
            AND   a.service_reg_no = #serviceRegNo#
        </isNotEmpty>
        <isNotEmpty property="termsRegNo">
            AND   a.terms_reg_no = #termsRegNo#
        </isNotEmpty>
    </insert>

    <update id="usr.AppDAO.deleteServiceTermsProfile" parameterClass="AppVO">
        update spt_customer_service_terms_profile
		set
			delete_date = sysdate(),
			update_date = sysdate(),
			update_id = #customerRegNo#
		where customer_reg_no = #customerRegNo#
		and terms_reg_no = #termsRegNo#
    </update>

    <insert id="usr.AppDAO.insertServiceTermsProfileHist" parameterClass="AppVO">
        INSERT INTO spt_customer_service_terms_profile_hist
		(
			customer_reg_no
		  , terms_reg_no
		  , terms_seq
		  , subcompany_code_id
		  , subcompany_name
		  , customer_name
		  , customer_email
		  , customer_birth_day
		  , terms_policy
		  , terms_auth_type
		  , terms_chg_date
		  , terms_start_date
		  , terms_expire_date
		  , terms_auth_yn
		  , terms_file_reg_no
		  , terms_file_status
		  , customer_sign_dn
		  , customer_sign_data
		  , customer_tsa_data
		  , admin_create_yn
		  , delete_date
		  , create_date
		  , create_id
		)
		SELECT
			a.customer_reg_no
		  , a.terms_reg_no
		  , ifnull((
				select ifnull(max(cast(terms_seq as SIGNED)), 0) + 1
				from spt_customer_service_terms_profile_hist aa
				where a.customer_reg_no = aa.customer_reg_no
			), 1)
		  , a.subcompany_code_id
		  , a.subcompany_name
		  , a.customer_name
		  , a.customer_email
		  , a.customer_birth_day
		  , a.terms_policy
		  , a.terms_auth_type
		  , a.terms_chg_date
		  , a.terms_start_date
		  , a.terms_expire_date
		  , a.terms_auth_yn
		  , a.terms_file_reg_no
		  , a.terms_file_status
		  , a.customer_sign_dn
		  , a.customer_sign_data
		  , a.customer_tsa_data
		  , a.admin_create_yn
		  , a.delete_date
		  , sysdate()
		  , a.create_id
		FROM spt_customer_service_terms_profile a
		WHERE a.customer_reg_no = #customerRegNo#
		AND   a.terms_reg_no = #termsRegNo#
    </insert>

    <select id="usr.AppDAO.selectAccountList" parameterClass="AppVO" resultClass="AppAccountVO">
        SELECT
				a.company_name_kor_alias		AS pubCompanyName,
				a.company_name_eng_alias		AS pubCompanyNameEng,
				a.company_code_id               AS pubCompanyCodeId,
				a.customer_vtaccount_no			AS customerVtaccountNo,
				a.customer_vtaccount_alias		AS customerVtaccountAlias,
				a.customer_vtaccount_status		AS customerVtaccountStatus,
				a.customer_realaccount_no       AS customerRealAccountNo,
				dec_char_sel(a.customer_realaccount_no,10,'ARIA','spt_customer_account_profile','costomer_realaccount_no',user(),connection_id())       AS customerRealAccountNoEncryption,
				IF(Isnull(b.company_code_id), 'false', 'true') AS isavailable,
				b.app_id                        AS appId,
				b.api_id                        AS apiId,
                (
                    SELECT  code_name_kor
                    FROM    com_system_code
                    WHERE concat(system_grp_code, system_code) = a.customer_realaccount_type) AS customerRealAccountTypeName,
                (
                    SELECT  code_name_eng
                    FROM    com_system_code
                    WHERE concat(system_grp_code, system_code) = a.customer_realaccount_type) AS customerRealAccountTypeNameEng,
                a.customer_realaccount_type AS customerRealAccountType
		FROM   (SELECT
					  a.customer_reg_no,
					  a.company_code_id,
					  b.company_name_kor_alias,
					  b.company_name_eng_alias,
					  a.customer_vtaccount_no,
					  a.customer_vtaccount_alias,
					  a.customer_vtaccount_status,
					  a.customer_realaccount_type,
					  a.customer_realaccount_no,
					  a.customer_vtaccount_reg_date,
					  a.customer_vtaccount_expire_date
				FROM   (SELECT *
						FROM   spt_customer_account_profile
						WHERE  customer_reg_no = #customerRegNo#
						AND customer_vtaccount_status = 'G009002'
						AND customer_vtaccount_expire_date IS NULL
						)a
				JOIN com_company_profile AS b
				ON a.company_code_id = b.company_code_id
				)a
		LEFT JOIN (SELECT 	a.app_id            AS app_id,
							a.api_id              AS api_id,
							a.company_code_id ,
							b.company_name_kor_alias    AS companyName,
							a.api_title                 AS apiName
					FROM (
						  SELECT  a.app_id,
								  a.api_id,
								  b.company_code_id,
								  b.api_title,
								  b.exposure_order
		  				  FROM  (SELECT app_id, api_id
								  FROM com_app_apilist_view
								  WHERE  app_id = #appId#
								  ) a,
								  com_api_info b
						  WHERE    a.api_id = b.api_id
						  AND    b.exposure_yn = 'Y'
						  AND    b.api_account_yn = 'Y'
						) a
					JOIN   com_company_profile AS b
					ON     a.company_code_id = b.company_code_id
					AND    b.delete_date IS NULL
					AND    b.exposure_yn = 'Y'
					ORDER BY     a.app_id, a.company_code_id, a.exposure_order
				) AS b
		ON a.company_code_id = b.company_code_id
		order by isavailable desc
    </select>

    <select id="usr.AppDAO.checkedCommonTerms" parameterClass="AppVO" resultClass="int">
        SELECT
              count(1)
        FROM spt_customer_common_terms_profile a,
              spt_customer_common_terms_pubcompany_profile b
        where a.customer_reg_no = b.customer_reg_no
        and a.delete_date is null
    	and b.delete_date is null         
        and a.terms_expire_date > sysdate()
        and a.customer_reg_no = #customerRegNo#
        <isNotEmpty property='companyCodeId'>
            and b.pubcompany_code_id =#companyCodeId#
        </isNotEmpty>
    </select>

    <select id="usr.AppDAO.checkedReSyncCommonTerms" parameterClass="AppVO" resultClass="TermsVO">
        SELECT
              DATEDIFF(a.terms_expire_date, SYSDATE()) as dateCount
        FROM spt_customer_common_terms_profile a
        where a.delete_date is null
        and   (date_format(sysdate(), '%Y%m%d') >= date_format(a.terms_expire_date - INTERVAL 1 MONTH, '%Y%m%d'))
        and a.customer_reg_no = #customerRegNo#
    </select>

    <select id="usr.AppDAO.checkedCustomerVerify" parameterClass="AppVO" resultClass="int">
        select  count(1) as count
        from    spt_customer_verify_profile
        where   customer_reg_no = #customerRegNo#
        and     customer_verify_type = 'G007002'
    </select>

    <select id="usr.AppDAO.selectBaseCommonTerms" parameterClass="AppVO" resultClass="TermsVO">
        SELECT  customer_name_kor as customerName,
                dec_char_sel(customer_email, 10, 'ARIA', 'spt_customer_info_profile', 'customer_email', user(), connection_id()) as customerEmail,
                date_format(dec_char_sel(customer_birth_day, 10, 'ARIA', 'spt_customer_info_profile', 'customer_birth_day', user(), connection_id()), '%Y년 %m월 %d일') as customerBirthDay,
                dec_char_sel(customer_phone, 10, 'ARIA', 'spt_customer_info_profile', 'customer_phone', user(), connection_id())  as customerPhone,
                date_format(sysdate(), '%Y년 %m월 %d일') as termsCreateDate,
                date_format(sysdate(), '%Y년 %m월 %d일') as termsStartDate,
                date_format(DATE_ADD(sysdate(),INTERVAL + 1 year) - INTERVAL 1 day,'%Y년 %m월 %d일') as termsEndDate
        FROM    spt_customer_info_profile
        WHERE   customer_reg_no = #customerRegNo#
    </select>

    <select id="usr.AppDAO.selectCommonTermsPubCompanyList" parameterClass="AppVO" resultClass="AppAccountVO">
        select
              ccp.company_code_id           as pubCompanyCodeId,       /* 기업프로파일.기업코드 */
              ccp.company_name_kor_alias    as pubCompanyName      /* 기업프로파일.기업이름한글 */
          from com_company_profile ccp /* 기업프로파일 */
          join (
              /* 계좌사용하는 API 기업만 조회 */
              select a.company_code_id
              from com_api_info a
              join com_api_view b on a.api_id = b.api_id
              join (
                  select a.api_id
                  from com_app_apilist_view a
                  left join com_api_info as b on a.api_id = b.api_id
                  where b.exposure_yn = 'Y'
                  and b.api_account_yn = 'Y'
                  group by a.api_id
              ) c on a.api_id = c.api_id
              where a.exposure_yn = 'Y'
              and a.api_account_yn = 'Y'
              group by a.company_code_id
          ) b on ccp.company_code_id = b.company_code_id
          where 1=1
          and ccp.delete_date is null
          and ccp.exposure_yn = 'Y'
        and ccp.company_service_type in ( 'G002001', 'G002002')
        order by ifnull(ccp.exposure_order, 'Z') asc, ccp.company_name_kor_alias asc
    </select>

    <select id="usr.AppDAO.selectMaxCommonTermsRegNo" parameterClass="TermsVO" resultClass="String">
        select  concat(date_format(sysdate(),'%Y%m%d'),
                    lpad((
                            select ifnull( max(cast(right(terms_reg_no,3) as signed)), 0)+1
                            from spt_customer_common_terms_profile
                            where left(terms_reg_no, 8) = date_format(sysdate(),'%Y%m%d')
                            and customer_reg_no = #customerRegNo#
                        ), 3, '0')
                    ) as termsRegNo
    </select>

    <select id="usr.AppDAO.selectMaxCommonTermsPubCompanyRegNo" parameterClass="TermsVO" resultClass="String">
        select  concat(date_format(sysdate(),'%Y%m%d'),
                    lpad((
                            select ifnull( max(cast(right(terms_pubcompany_reg_no,3) as signed)), 0)+1
                            from spt_customer_common_terms_pubcompany_profile
                            where left(terms_pubcompany_reg_no, 8) = date_format(sysdate(),'%Y%m%d')
                            and customer_reg_no = #customerRegNo#
                            and terms_reg_no = #termsRegNo#
                        ), 3, '0')
                    ) as termsPubcompanyRegNo
    </select>

    <insert id="usr.AppDAO.insertCustomerCommonTermsProfile" parameterClass="TermsVO">
        INSERT INTO spt_customer_common_terms_profile
        (
            customer_reg_no
          , terms_reg_no
          , customer_name
          , customer_email
          , customer_birth_day
          , terms_policy
          , terms_auth_type
          , terms_chg_date
          , terms_start_date
          , terms_expire_date
          , terms_auth_yn
          , terms_file_reg_no
          , terms_file_status
          , customer_sign_dn
          , customer_sign_data
          , customer_tsa_data
          , admin_create_yn
          , create_date
          , create_id
          , update_date
          , update_id
        )
        SELECT  a.customer_reg_no       as customer_reg_no,
                #termsRegNo#           as terms_reg_no,
                a.customer_name_kor     as customer_name,
                a.customer_email        as customer_email,
                a.customer_birth_day    as customer_birth_day,
                '12'                    as terms_policy,
                'G032001'               as terms_auth_type,
                sysdate()               as terms_chg_date,
                date_format(sysdate(),'%Y%m%d') as terms_start_date,
                date_format(DATE_ADD(sysdate(),INTERVAL + 1 year) - INTERVAL 1 day,'%Y%m%d') as terms_expire_date,
                'N'                     as terms_auth_yn,
                #termsFileRegNo#       as terms_file_reg_no,
                'G028030'               as terms_file_status,
                #customerSignDn#       as customer_sign_dn,
                #customerSignData#     as customer_sign_data,
                #customerTsaData#      as customer_tsa_data,
                'N'                     as admin_create_yn,
                sysdate()               as create_date,
                #customerRegNo#        as create_id,
                sysdate()               as update_date,
                #customerRegNo#        as update_id
        FROM(
            SELECT  customer_reg_no,
            customer_name_kor,
            customer_email,
            customer_birth_day
            FROM spt_customer_info_profile
            WHERE customer_reg_no = #customerRegNo#
        ) a
    </insert>

    <insert id="usr.AppDAO.insertCustomerCommonTermsProfileHist" parameterClass="TermsVO">
        INSERT INTO spt_customer_common_terms_profile_hist
        (
            customer_reg_no
          , terms_reg_no
          , terms_seq
          , customer_name
          , customer_email
          , customer_birth_day
          , terms_policy
          , terms_auth_type
          , terms_chg_date
          , terms_start_date
          , terms_expire_date
          , terms_auth_yn
          , terms_file_reg_no
          , terms_file_status
          , customer_sign_dn
          , customer_sign_data
          , customer_tsa_data
          , admin_create_yn
          , delete_date
          , create_date
          , create_id
          , update_date
          , update_id
        )
        SELECT
            a.customer_reg_no
          , a.terms_reg_no
          , ifnull((
                    select ifnull(max(cast(terms_seq as SIGNED)), 0) + 1
                    from spt_customer_common_terms_profile_hist aa
                    where a.customer_reg_no = aa.customer_reg_no
            ), 1)
          , a.customer_name
          , a.customer_email
          , a.customer_birth_day
          , a.terms_policy
          , a.terms_auth_type
          , a.terms_chg_date
          , a.terms_start_date
          , a.terms_expire_date
          , a.terms_auth_yn
          , a.terms_file_reg_no
          , a.terms_file_status
          , a.customer_sign_dn
          , a.customer_sign_data
          , a.customer_tsa_data
          , a.admin_create_yn
          , a.delete_date
          , a.create_date
          , a.create_id
          , a.update_date
          , a.update_id
        FROM spt_customer_common_terms_profile a
        WHERE a.customer_reg_no = #customerRegNo#
        AND   a.terms_reg_no = #termsRegNo#
    </insert>

    <insert id="usr.AppDAO.insertCustomerCommonTermsPubCompanyProfile" parameterClass="TermsPubCompanyVO">
        INSERT INTO spt_customer_common_terms_pubcompany_profile
        (
            customer_reg_no
          , terms_reg_no
          , terms_pubcompany_reg_no
          , pubcompany_code_id
          , pubcompany_name
          , terms_chg_date
          , create_date
          , create_id
          , update_date
          , update_id
        )
        select  #customerRegNo#        as customer_reg_no,
                #termsRegNo#           as terms_reg_no,
                #termsPubCompanyRegNo#  as terms_pubcompany_reg_no,
                company_code_id         as pubcompany_code_id,
                company_name_kor_alias        as pubcompany_name,
                sysdate()               as terms_chg_date,
                sysdate()               as create_date,
                #customerRegNo#        as create_id,
                sysdate()               as update_date,
                #customerRegNo#        as update_id
        from com_company_profile
        where company_code_id = #pubCompanyCodeId#
        and delete_date is null
        and exposure_yn = 'Y'
    </insert>

    <insert id="usr.AppDAO.insertCustomerCommonTermsPubCompanyProfileHist" parameterClass="TermsPubCompanyVO">
        INSERT INTO spt_customer_common_terms_pubcompany_profile_hist
        (
        customer_reg_no
        , terms_reg_no
        , terms_pubcompany_reg_no
        , terms_pubcompany_seq
        , pubcompany_code_id
        , pubcompany_name
        , terms_chg_date
        , delete_date
        , create_date
        , create_id
        , update_date
        , update_id
        )
        SELECT
        a.customer_reg_no
        , a.terms_reg_no
        , a.terms_pubcompany_reg_no
        , ifnull((
        select ifnull(max(cast(terms_pubcompany_seq as SIGNED)), 0) + 1
        from spt_customer_common_terms_pubcompany_profile_hist
        where customer_reg_no = a.customer_reg_no
        and terms_reg_no = a.terms_reg_no
        and terms_pubcompany_reg_no = a.terms_pubcompany_reg_no
        ), 1)
        , a.pubcompany_code_id
        , a.pubcompany_name
        , a.terms_chg_date
        , a.delete_date
        , a.create_date
        , a.create_id
        , a.update_date
        , a.update_id
        FROM spt_customer_common_terms_pubcompany_profile a
        WHERE a.customer_reg_no = #customerRegNo#
        AND   a.terms_reg_no = #termsRegNo#
        <isNotEmpty property="termsPubCompanyRegNo">
            AND   a.terms_pubcompany_reg_no = #termsPubCompanyRegNo#
        </isNotEmpty>
    </insert>

    <insert id="usr.AppDAO.insertCustomerVerifyProfile" parameterClass="TermsVO">
        INSERT INTO spt_customer_verify_profile
        (
            customer_reg_no,
            customer_verify_type,
            customer_verify,
            customer_verify_date,
            create_date,
            create_id,
            update_date,
            update_id
        ) VALUES (
            #customerRegNo#,
            'G007002',
            #customerSignDn#,
            sysdate(),
            sysdate(),
            #customerRegNo#,
            sysdate(),
            #customerRegNo#
        ) ON DUPLICATE KEY UPDATE
        customer_verify = #customerSignDn#,
        update_date = sysdate(),
        update_id = #customerRegNo#
    </insert>

    <insert id="usr.AppDAO.insertCustomerVerifyProfileHist" parameterClass="TermsVO">
        insert into spt_customer_verify_profile_hist(
                customer_verify_seq,  /* 순번 */
                customer_reg_no,      /* 회원OP등록번호 */
                customer_verify_type, /* 회원검증종류  */
                customer_verify,      /* 회원검증값 */
                customer_verify_date, /* 회원검증일시 */
                delete_date,          /* 삭제일시 */
                create_date,          /* 생성일시 */
                create_id             /* 생성자 ID */
            )
            select
                ifnull((
                    select ifnull(max(cast(customer_verify_seq as SIGNED)), 0) + 1
                    from spt_customer_verify_profile_hist
                    where customer_reg_no = a.customer_reg_no
                ), 1),                /* 순번 */
                customer_reg_no,      /* 회원OP등록번호 */
                customer_verify_type, /* 회원검증종류  */
                customer_verify,      /* 회원검증값 */
                customer_verify_date, /* 회원검증일시 */
                delete_date,          /* 삭제일시 */
                create_date,          /* 생성일시 */
                create_id             /* 생성자 ID */
            from spt_customer_verify_profile a
            where 1=1
            and customer_reg_no = #customerRegNo# /* 회원OP등록번호 */
            and customer_verify_type = 'G007002' /* 회원검증종류  */
    </insert>

    <update id="usr.AppDAO.deleteCustomerCommonTermsProfile" parameterClass="TermsVO">
        update  spt_customer_common_terms_profile
        set     delete_date = sysdate(),
                update_date = sysdate(),
                update_id = #customerRegNo#
        WHERE   customer_reg_no = #customerRegNo#
        AND     terms_reg_no = #termsRegNo#
        AND     delete_date is null
    </update>

    <update id="usr.AppDAO.deleteCustomerCommonTermsPubCompanyProfile" parameterClass="TermsVO">
        update  spt_customer_common_terms_pubcompany_profile
        set     delete_date = sysdate(),
                update_date = sysdate(),
                update_id = #customerRegNo#
        where   customer_reg_no = #customerRegNo#
        and     terms_reg_no = #termsRegNo#
        and     delete_date is null
    </update>

    <select id="usr.AppDAO.selectCommonTermsInfo" parameterClass="TermsVO" resultClass="TermsVO">
        select
			 a.customer_reg_no    as customerRegNo
			,a.terms_reg_no       as termsRegNo
			,a.terms_auth_type    as termsAuthType
			,a.customer_name      as customerName
			,dec_char_sel(a.customer_email,
							10,
							'ARIA',
							'spt_customer_service_terms_profile',
							'customer_email',
							user(),
							connection_id())              as customerEmail
			,dec_char_sel(a.customer_birth_day,
							10,
							'ARIA',
							'spt_customer_service_terms_profile',
							'customer_birth_day',
							user(),
							connection_id())      as customerBirthDay
			,ifnull(a.terms_policy/12,1) as termsPolicyYear
			,ifnull(date_format(a.terms_chg_date, '%Y년%m월%d일'),date_format(sysdate(),'%Y%m%d')) as termsCreateDate
			,ifnull(date_format(a.terms_start_date, '%Y년%m월%d일'), date_format(sysdate(),'%Y%m%d')) as termsStartDate
			,date_format(a.terms_expire_date, '%Y년%m월%d일')  as termsEndDate
			,'G030001'   /*동의 : G030001*/ as termsStatus
			,a.customer_sign_dn   as customerSignDn
			,a.customer_sign_data as customerSignData
			,a.customer_tsa_data  as customerTsaData
			,a.delete_date        as deleteDate
			,dec_char_sel(c.customer_phone,
							10,
							'ARIA',
							'spt_customer_info_profile',
							'customer_phone',
							user(),
							connection_id())  as customerPhone
		from spt_customer_common_terms_profile a
		left join spt_customer_info_profile c on a.customer_reg_no = c.customer_reg_no
		where   a.customer_reg_no = #customerRegNo#
		and     a.delete_date is null
		limit 0,1
    </select>

    <select id="usr.AppDAO.checkedAppTerms" parameterClass="AppVO" resultClass="String">
        select a.terms_reg_no as termsRegNo
        from spt_customer_service_terms_profile a
        inner join spt_customer_service_terms_pubcompany_profile b
        on a.customer_reg_no = b.customer_reg_no
        and a.terms_reg_no = b.terms_reg_no
        inner join spt_customer_service_profile c
        on c.customer_reg_no = b.customer_reg_no
        and c.terms_reg_no = b.terms_reg_no
        where a.customer_reg_no = #customerRegNo#
        and a.delete_date is null
        and a.terms_expire_date > sysdate()
        and a.terms_auth_yn = 'N'
        and b.delete_date is null
        and c.delete_date is null
        <isNotEmpty property="pubCompanyCodeId">
            and b.pubcompany_code_id = #pubCompanyCodeId#
        </isNotEmpty>
        and a.subcompany_code_id = #subCompanyCodeId#
        group by a.terms_reg_no
    </select>

    <select id="usr.AppDAO.selectSubCompanyInfo" parameterClass="AppVO" resultClass="AppVO">
        SELECT
			a.company_code_id as subCompanyCodeId,
			c.company_name_kor_alias as subCompanyName,
			a.app_name as appName
		FROM 		com_app_view a
		INNER JOIN 	com_app_info b
		ON 			a.app_id = b.app_id
		INNER JOIN 	com_company_profile c
		ON 			c.company_code_id = a.company_code_id
		AND			c.delete_date is null
		AND 		c.exposure_yn = 'Y'
		WHERE  		a.app_status = 'G022002'                     /*app 상태 (CA 정보)*/
		AND    		b.exposure_yn = 'Y'
		AND			a.app_id = #appId#
    </select>

    <select id="usr.AppDAO.selectAppTermsPubCompanyList" parameterClass="AppVO" resultClass="String">
        select ifnull(b.company_name_kor_alias, a.pubcompany_name)    as pubCompanyName
		from 	spt_customer_service_terms_pubcompany_profile a
		left join com_company_profile as b
		on 		a.pubcompany_code_id = b.company_code_id
		where 	a.customer_reg_no = #customerRegNo#
		and 	a.terms_reg_no = #termsRegNo#
		order by pubCompanyName
    </select>

    <select id="usr.AppDAO.selectAppTermsPubCompanyInfoList" parameterClass="AppVO" resultClass="TermsPubCompanyVO">
        select ifnull(b.company_name_kor_alias, a.pubcompany_name)    as pubCompanyName,
				a.pubcompany_code_id as pubCompanyCodeId,
				a.customer_reg_no as customerRegNo
		from 	spt_customer_service_terms_pubcompany_profile a
		left join com_company_profile as b
		on 		a.pubcompany_code_id = b.company_code_id
		where 	a.customer_reg_no = #customerRegNo#
		and 	a.terms_reg_no = #termsRegNo#
		order by pubCompanyName
    </select>

    <select id="usr.AppDAO.checkCreatedCustomerServiceTermsPubCompanyProfile" parameterClass="TermsPubCompanyVO" resultClass="int">
        select count(1)
		from spt_customer_service_terms_pubcompany_profile
		where customer_reg_no = #customerRegNo#
		and terms_reg_no = #termsRegNo#
		and pubcompany_code_id = #pubCompanyCodeId#
		and delete_date is null
    </select>

    <select id="usr.AppDAO.selectMaxServiceRegNo" parameterClass="TermsVO" resultClass="String">
        select  concat(date_format(sysdate(),'%Y%m%d'),
						lpad((
								select ifnull( max(cast(right(service_reg_no,3) as signed)), 0)+1
								from spt_customer_service_profile
								where left(service_reg_no, 8) = date_format(sysdate(),'%Y%m%d')
								and customer_reg_no = #customerRegNo#
							), 3, '0')
						) as serviceRegNo
    </select>
    <select id="usr.AppDAO.selectMaxServiceAccountRegNo" parameterClass="TermsVO" resultClass="String">
        select  concat(date_format(sysdate(),'%Y%m%d'),
                    lpad((
                            select ifnull( max(cast(right(account_reg_no,3) as signed)), 0)+1
                            from spt_customer_service_account_profile
                            where left(account_reg_no, 8) = date_format(sysdate(),'%Y%m%d')
                            and customer_reg_no = #customerRegNo#
                            and service_reg_no = #serviceRegNo#
                        ), 3, '0')
                    ) as accountRegNo
    </select>
    <select id="usr.AppDAO.selectMaxTermsRegNo" parameterClass="TermsVO" resultClass="String">
        select  concat(date_format(sysdate(),'%Y%m%d'),
                    lpad((
                            select ifnull( max(cast(right(terms_reg_no,3) as signed)), 0)+1
                            from spt_customer_service_terms_profile
                            where left(terms_reg_no, 8) = date_format(sysdate(),'%Y%m%d')
                            and customer_reg_no = #customerRegNo#
                        ), 3, '0')
                    ) as termsRegNo
    </select>
    <select id="usr.AppDAO.selectMaxTermsPubCompanyRegNo" parameterClass="TermsVO" resultClass="String">
        select  concat(date_format(sysdate(),'%Y%m%d'),
                    lpad((
                            select ifnull( max(cast(right(terms_pubcompany_reg_no,3) as signed)), 0)+1
                            from spt_customer_service_terms_pubcompany_profile
                            where left(terms_pubcompany_reg_no, 8) = date_format(sysdate(),'%Y%m%d')
                            and customer_reg_no = #customerRegNo#
                            and terms_reg_no = #termsRegNo#
                        ), 3, '0')
                    ) as termsPubcompanyRegNo
    </select>
    <select id="usr.AppDAO.selectMaxTermsArsRegNo" parameterClass="TermsVO" resultClass="String">
        select
            concat(date_format(sysdate(),'%Y%m%d'),
                   lpad( (select ifnull( max(cast(right(terms_ars_reg_no,4) as signed)), 0)+1
                          from spt_customer_service_ars_profile where left(terms_ars_reg_no,8) = date_format(sysdate(),'%Y%m%d')
                          and customer_reg_no = #customerRegNo#
                          )
                          ,4,'0')
                   ) as termsArsRegNo
    </select>
    <insert id="usr.AppDAO.insertCustomerServiceProfile" parameterClass="TermsVO">
        INSERT INTO spt_customer_service_profile
		(
			customer_reg_no
		  , service_reg_no
		  , app_id
		  , terms_reg_no
		  , create_date
		  , create_id
		  , update_date
		  , update_id
		) VALUES (
			#customerRegNo#
		  , #serviceRegNo#
		  , #appId#
		  , #termsRegNo#
		  , sysdate()
		  , #customerRegNo#
		  , sysdate()
		  , #customerRegNo#
		)
    </insert>
    <insert id="usr.AppDAO.insertCustomerServiceProfileHist" parameterClass="TermsVO">
        INSERT INTO spt_customer_service_profile_hist
        (
        customer_reg_no
        , service_reg_no
        , service_seq
        , app_id
        , terms_reg_no
        , delete_date
        , create_date
        , create_id
        )
        SELECT
        a.customer_reg_no
        , a.service_reg_no
        , ifnull((
        select ifnull(max(cast(service_seq as SIGNED)), 0) + 1
        from spt_customer_service_profile_hist
        where customer_reg_no = a.customer_reg_no
        and service_reg_no = a.service_reg_no
        ), 1)
        , a.app_id
        , a.terms_reg_no
        , a.delete_date
        , sysdate()
        , a.create_id
        FROM spt_customer_service_profile a
        WHERE a.customer_reg_no = #customerRegNo#
        <isNotEmpty property="serviceRegNo">
            AND   a.service_reg_no = #serviceRegNo#
        </isNotEmpty>
        <isNotEmpty property="termsRegNo">
            AND   a.terms_reg_no = #termsRegNo#
        </isNotEmpty>
    </insert>
    <insert id="usr.AppDAO.insertCustomerServiceAccountProfile" parameterClass="AppAccountVO">
        INSERT INTO spt_customer_service_account_profile
		(
			customer_reg_no
		  , service_reg_no
		  , account_reg_no
		  , app_id
		  , api_id
		  , customer_realaccount_no
		  , create_date
		  , create_id
		  , update_date
		  , update_id
		) VALUES (
			#customerRegNo#
		  , #serviceRegNo#
		  , #accountRegNo#
		  , #appId#
		  , #apiId#
		  , #customerRealAccountNo#
		  , sysdate()
		  , #customerRegNo#
		  , sysdate()
		  , #customerRegNo#
		)
    </insert>
    <insert id="usr.AppDAO.insertCustomerServiceAccountProfileHist" parameterClass="AppAccountVO">
        INSERT INTO spt_customer_service_account_profile_hist
		(
			customer_reg_no
		  , service_reg_no
		  , account_reg_no
		  , account_seq
		  , app_id
		  , api_id
		  , customer_realaccount_no
		  , delete_date
		  , create_date
		  , create_id
		)
		SELECT
			a.customer_reg_no
		  , a.service_reg_no
		  , a.account_reg_no
		  , ifnull((
                    select ifnull(max(cast(account_seq as SIGNED)), 0) + 1
                    from spt_customer_service_account_profile_hist
                    where customer_reg_no = a.customer_reg_no
                    and service_reg_no = a.service_reg_no
                    and account_reg_no = a.account_reg_no
                ), 1)
		  , a.app_id
		  , a.api_id
		  , a.customer_realaccount_no
		  , a.delete_date
		  , sysdate()
		  , a.create_id
		FROM spt_customer_service_account_profile a
		WHERE a.customer_reg_no = #customerRegNo#
		AND   a.service_reg_no = #serviceRegNo#
		AND   a.account_reg_no = #accountRegNo#
    </insert>
    <insert id="usr.AppDAO.insertCustomerServiceTermsProfile" parameterClass="TermsVO">
        INSERT INTO spt_customer_service_terms_profile
        (
        customer_reg_no
        , terms_reg_no
        , subcompany_code_id
        , subcompany_name
        , customer_name
        , customer_email
        , customer_birth_day
        , terms_policy
        , terms_auth_type
        , terms_chg_date
        , terms_start_date
        , terms_expire_date
        , terms_auth_yn
        , terms_file_reg_no
        , terms_file_status
        , customer_sign_dn
        , customer_sign_data
        , customer_tsa_data
        , admin_create_yn
        , create_date
        , create_id
        , update_date
        , update_id
        )
        SELECT  a.customer_reg_no,
                #termsRegNo#           as terms_reg_no,
                b.company_code_id       as subcompany_code_id,
                b.company_name_kor_alias      as subcompany_name,
                a.customer_name_kor     as customer_name,
                a.customer_email        as customer_email,
                a.customer_birth_day    as customer_birth_day,
                #termsPolicy#          as terms_policy,
                #termsAuthType#		as terms_auth_type,
                sysdate()				as terms_chg_date,
                date_format(sysdate(),'%Y%m%d')	as terms_start_date,
                <isNotEmpty property="termsExpireDate">
                    #termsExpireDate#  as terms_expire_date,
                </isNotEmpty>
                <isEmpty property="termsExpireDate">
                    date_format(DATE_ADD(sysdate(),INTERVAL + 1 year) - INTERVAL 1 day,'%Y%m%d') as terms_expire_date,
                </isEmpty>
                'N'                     as terms_auth_yn,
                #termsFileRegNo#       as terms_file_reg_no,
                'G028030'      			as terms_file_status,
                #customerSignDn#       as customer_sign_dn,
                #customerSignData#		as customer_sign_data,
                #customerTsaData#		as customer_tsa_data,
                'N'						as admin_create_yn,
                sysdate()               as create_date,
                #customerRegNo#        as create_id,
                sysdate()               as update_date,
                #customerRegNo#        as update_id
        FROM(
            SELECT  customer_reg_no,
                    customer_name_kor,
                    customer_email,
                    customer_birth_day
            FROM spt_customer_info_profile
            WHERE customer_reg_no = #customerRegNo#
        ) a
        LEFT OUTER JOIN (
            SELECT  #customerRegNo#     as customer_reg_no,
                    company_code_id,
                    company_name_kor_alias
            FROM com_company_profile
            WHERE company_code_id = #subCompanyCodeId#
            AND delete_date is null
            AND exposure_yn = 'Y'
        ) b ON a.customer_reg_no = b.customer_reg_no
    </insert>
    <insert id="usr.AppDAO.insertCustomerServiceTermsProfileHist" parameterClass="TermsVO">
        INSERT INTO spt_customer_service_terms_profile_hist
        (
        customer_reg_no
        , terms_reg_no
        , terms_seq
        , subcompany_code_id
        , subcompany_name
        , customer_name
        , customer_email
        , customer_birth_day
        , terms_policy
        , terms_auth_type
        , terms_chg_date
        , terms_start_date
        , terms_expire_date
        , terms_auth_yn
        , terms_file_reg_no
        , terms_file_status
        , customer_sign_dn
        , customer_sign_data
        , customer_tsa_data
        , admin_create_yn
        , delete_date
        , create_date
        , create_id
        )
        SELECT
        a.customer_reg_no
        , a.terms_reg_no
        , ifnull((
        select ifnull(max(cast(terms_seq as SIGNED)), 0) + 1
        from spt_customer_service_terms_profile_hist aa
        where a.customer_reg_no = aa.customer_reg_no
        ), 1)
        , a.subcompany_code_id
        , a.subcompany_name
        , a.customer_name
        , a.customer_email
        , a.customer_birth_day
        , a.terms_policy
        , a.terms_auth_type
        , a.terms_chg_date
        , a.terms_start_date
        , a.terms_expire_date
        , a.terms_auth_yn
        , a.terms_file_reg_no
        , a.terms_file_status
        , a.customer_sign_dn
        , a.customer_sign_data
        , a.customer_tsa_data
        , a.admin_create_yn
        , a.delete_date
        , sysdate()
        , a.create_id
        FROM spt_customer_service_terms_profile a
        WHERE a.customer_reg_no = #customerRegNo#
        AND   a.terms_reg_no = #termsRegNo#
    </insert>
    <insert id="usr.AppDAO.insertCustomerServiceTermsPubCompanyProfile" parameterClass="TermsPubCompanyVO">
        INSERT INTO spt_customer_service_terms_pubcompany_profile
		(
			customer_reg_no
		  , terms_reg_no
		  , terms_pubcompany_reg_no
		  , pubcompany_code_id
		  , pubcompany_name
		  , terms_chg_date
		  , create_date
		  , create_id
		  , update_date
		  , update_id
		)
		select  #customerRegNo#        as customer_reg_no,
				#termsRegNo#           as terms_reg_no,
				#termsPubCompanyRegNo#  as terms_pubcompany_reg_no,
				company_code_id         as pubcompany_code_id,
				company_name_kor_alias        as pubcompany_name,
				sysdate()				as terms_chg_date,
				sysdate()               as create_date,
				#customerRegNo#        as create_id,
				sysdate()               as update_date,
				#customerRegNo#        as update_id
		from com_company_profile
		where company_code_id = #pubCompanyCodeId#
		and delete_date is null
		and exposure_yn = 'Y'
    </insert>
    <insert id="usr.AppDAO.insertCustomerServiceTermsPubCompanyProfileHist" parameterClass="TermsPubCompanyVO">
        INSERT INTO spt_customer_service_terms_pubcompany_profile_hist
		(
			customer_reg_no
		  , terms_reg_no
		  , terms_pubcompany_reg_no
		  , terms_pubcompany_seq
		  , pubcompany_code_id
		  , pubcompany_name
		  , terms_chg_date
		  , delete_date
		  , create_date
		  , create_id
		)
		SELECT
			a.customer_reg_no
		  , a.terms_reg_no
		  , a.terms_pubcompany_reg_no
		  , ifnull((
                    select ifnull(max(cast(terms_pubcompany_seq as SIGNED)), 0) + 1
                    from spt_customer_service_terms_pubcompany_profile_hist
                    where customer_reg_no = a.customer_reg_no
                    and terms_reg_no = a.terms_reg_no
                    and terms_pubcompany_reg_no = a.terms_pubcompany_reg_no
                ), 1)
		  , a.pubcompany_code_id
		  , a.pubcompany_name
		  , a.terms_chg_date
		  , a.delete_date
		  , a.create_date
		  , a.create_id
		FROM spt_customer_service_terms_pubcompany_profile a
		WHERE a.customer_reg_no = #customerRegNo#
		AND   a.terms_reg_no = #termsRegNo#
		AND   a.terms_pubcompany_reg_no = #termsPubCompanyRegNo#
    </insert>
    <insert id="usr.AppDAO.insertCustomerServiceArsProfile" parameterClass="TermsVO">
        INSERT INTO spt_customer_service_ars_profile
		(
			customer_reg_no
		  , terms_reg_no
		  , terms_ars_reg_no
		  , customer_phone
		  , ars_record_data
		  , ars_txt_no
		  , ars_tr_cd
		  , ars_rslt_msg
		  , ars_rslt_cd
		  , create_date
		  , create_id
		  , update_date
		  , update_id
		) VALUES (
			#customerRegNo#
		  , #termsRegNo#
		  , #termsArsRegNo#
		  , #customerPhone#
		  , #arsRecordData#
		  , #arsTxtNo#
		  , #arsTrCd#
		  , #arsResultMessage#
		  , #arsResultCd#
		  , sysdate()
		  , #customerRegNo#
		  , sysdate()
		  , #customerRegNo#
		)
    </insert>
    <insert id="usr.AppDAO.insertCustomerServiceArsProfileHist" parameterClass="TermsVO">
        INSERT INTO spt_customer_service_ars_profile_hist
		(
			customer_reg_no
		  , terms_reg_no
		  , terms_ars_seq
		  , terms_ars_reg_no
		  , customer_phone
		  , ars_record_data
		  , ars_txt_no
		  , ars_tr_cd
		  , ars_rslt_msg
		  , ars_rslt_cd
		  , create_date
		  , create_id
		  , update_date
		  , update_id
		)
		SELECT
			a.customer_reg_no
		  , a.terms_reg_no
		  , ifnull((
					select ifnull(max(cast(terms_ars_seq as SIGNED)), 0) + 1
					from spt_customer_service_ars_profile_hist aa
					where a.customer_reg_no = aa.customer_reg_no
							  and a.terms_reg_no = aa.terms_reg_no
							  and a.terms_ars_reg_no = aa.terms_ars_reg_no
				), 1)
		  , a.terms_ars_reg_no
		  , a.customer_phone
		  , a.ars_record_data
		  , a.ars_txt_no
		  , a.ars_tr_cd
		  , a.ars_rslt_msg
		  , a.ars_rslt_cd
		  , a.create_date
		  , a.create_id
		  , a.update_date
		  , a.update_id
		FROM spt_customer_service_ars_profile a
		WHERE a.customer_reg_no = #customerRegNo#
		AND   a.terms_reg_no = #termsRegNo#
		AND   a.terms_ars_reg_no = #termsArsRegNo#
    </insert>
    <update id="usr.AppDAO.updateCustomerServiceProfile" parameterClass="TermsVO">
        update spt_customer_service_profile
        set terms_reg_no = #termsRegNo#,
            update_date = sysdate(),
            update_id = #customerRegNo#
        where customer_reg_no = #customerRegNo#
        and app_id = #appId#
        and delete_date is null
    </update>
    <update id="usr.AppDAO.deleteCustomerServiceAccountProfile" parameterClass="AppAccountVO">
        update spt_customer_service_account_profile
		set		delete_date = sysdate(),
				update_date = sysdate(),
				update_id = #customerRegNo#
		where	customer_reg_no = #customerRegNo#
		and		service_reg_no = #serviceRegNo#
		and		account_reg_no = #accountRegNo#
    </update>
    <!-- 앱삭제시 서비스 연결 계좌정보도 삭제 -->
    <update id="usr.AppDAO.deleteCustomerServiceAccountProfileAll" parameterClass="AppAccountVO">
        update spt_customer_service_account_profile
		set		delete_date = sysdate(),
				update_date = sysdate(),
				update_id = #customerRegNo#
		where	customer_reg_no = #customerRegNo#
		and		service_reg_no = #serviceRegNo#
    </update>
    <insert id="usr.AppDAO.insertCustomerServiceAccountProfileHistAll" parameterClass="AppAccountVO">
        INSERT INTO spt_customer_service_account_profile_hist
        (
            customer_reg_no
          , service_reg_no
          , account_reg_no
          , account_seq
          , app_id
          , api_id
          , customer_realaccount_no
          , delete_date
          , create_date
          , create_id
        )
        SELECT
            a.customer_reg_no
          , a.service_reg_no
          , a.account_reg_no
          , ifnull((
                    select ifnull(max(cast(account_seq as SIGNED)), 0) + 1
                    from spt_customer_service_account_profile_hist
                    where customer_reg_no = a.customer_reg_no
                    and service_reg_no = a.service_reg_no
                    and account_reg_no = a.account_reg_no
                ), 1)
          , a.app_id
          , a.api_id
          , a.customer_realaccount_no
          , a.delete_date
          , sysdate()
          , a.create_id
        FROM spt_customer_service_account_profile a
        WHERE a.customer_reg_no = #customerRegNo#
        AND   a.service_reg_no = #serviceRegNo#
    </insert>
    
    <select id="usr.AppDAO.selectAppTermsInfo" parameterClass="AppVO" resultClass="TermsVO">
        select
			 a.customer_reg_no    	as customerRegNo
			,a.terms_reg_no       	as termsRegNo
			,a.terms_auth_type    	as termsAuthType
			,e.company_name_kor_alias as subCompanyName
			,e.company_code_id as subCompanyCodeId
			,a.customer_name      	as customerName
			,dec_char_sel(a.customer_email,
							10,
							'ARIA',
							'spt_customer_service_terms_profile',
							'customer_email',
							user(),
							connection_id())              			as customerEmail
			,date_format(dec_char_sel(a.customer_birth_day,
							10,
							'ARIA',
							'spt_customer_service_terms_profile',
							'customer_birth_day',
							user(),
							connection_id()), '%Y년 %m월 %d일')		as customerBirthDay
			,ifnull(a.terms_policy/12,1) as termsPolicyYear
			,ifnull(date_format(a.terms_chg_date, '%Y년 %m월 %d일'),date_format(sysdate(),'%Y년 %m월 %d일')) as termsCreateDate
			,date_format(a.terms_start_date,'%Y년 %m월 %d일') as termsStartDate
			,date_format(a.terms_expire_date,'%Y년 %m월 %d일')  as termsEndDate
			,'G030001'   /*동의 : G030001*/ as termsStatus
			,a.customer_sign_dn   as customerSignDn
			,case a.terms_auth_type
				when 'G032001' then a.customer_sign_data
				else
					dec_char_sel(b.customer_phone,
								10,
								'ARIA',
								'spt_customer_service_ars_profile',
								'customer_phone',
								user(),
								connection_id())
			end as customerSignData
			,case a.terms_auth_type when 'G032001' then a.customer_tsa_data else b.ars_txt_no end as customerTsaData
			,a.delete_date        as deleteDate
			,dec_char_sel(c.customer_phone,
							10,
							'ARIA',
							'spt_customer_info_profile',
							'customer_phone',
							user(),
							connection_id())  as customerPhone
		from spt_customer_service_terms_profile a
		inner join (
				select 	terms_reg_no as terms_reg_no
						,app_id as app_id
				from 	spt_customer_service_profile
				where 	customer_reg_no = #customerRegNo#
				and 	app_id = #appId#
				and 	delete_date is null) d
		on 	d.terms_reg_no = a.terms_reg_no
		inner join (
			SELECT
					a.app_id as app_id,
					a.company_code_id as company_code_id,
					c.company_name_kor_alias as company_name_kor_alias
			FROM 		com_app_view a
        	INNER JOIN 	com_app_info b
        	ON 			a.app_id = b.app_id
        	INNER JOIN 	com_company_profile c
        	ON 			c.company_code_id = a.company_code_id
			AND			c.delete_date is null
        	AND 		c.exposure_yn = 'Y'
			WHERE  		a.app_status = 'G022002'                     /*app 상태 (CA 정보)*/
/*			AND    		b.exposure_yn = 'Y'*/
		) e on e.app_id = d.app_id
		left join spt_customer_service_ars_profile b on a.customer_reg_no = b.customer_reg_no AND a.terms_reg_no = b.terms_reg_no
		left join spt_customer_info_profile c on a.customer_reg_no = c.customer_reg_no
		where 	a.customer_reg_no = #customerRegNo#
		limit 0,1
    </select>
    <select id="usr.AppDAO.selectEncCustomerPhoneNumber" parameterClass="TermsVO" resultClass="String">
        SELECT
			c.customer_phone  as customerPhone
		FROM spt_customer_info_profile c
		WHERE c.customer_reg_no = #customerRegNo#
    </select>
    <select id="usr.AppDAO.selectAppTermsInfoForDiscard" parameterClass="AppVO" resultClass="TermsVO">
        select
			 a.customer_reg_no    	as customerRegNo
			,a.terms_reg_no       	as termsRegNo
			,a.terms_auth_type    	as termsAuthType
			,e.company_name_kor_alias as subCompanyName
			,e.company_code_id as subCompanyCodeId
			,a.customer_name      	as customerName
			,dec_char_sel(a.customer_email,
							10,
							'ARIA',
							'spt_customer_service_terms_profile',
							'customer_email',
							user(),
							connection_id())              			as customerEmail
			,date_format(dec_char_sel(a.customer_birth_day,
							10,
							'ARIA',
							'spt_customer_service_terms_profile',
							'customer_birth_day',
							user(),
							connection_id()), '%Y년 %m월 %d일')		as customerBirthDay
			,ifnull(a.terms_policy/12,1) as termsPolicyYear
			,ifnull(date_format(a.terms_chg_date, '%Y년 %m월 %d일'),date_format(sysdate(),'%Y년 %m월 %d일')) as termsCreateDate
			,date_format(a.terms_start_date,'%Y년 %m월 %d일') as termsStartDate
			,date_format(a.terms_expire_date,'%Y년 %m월 %d일')  as termsEndDate
			,case when
				a.delete_date is not null
		    then
		        'G030003'   /*폐기 : G030003*/
		    else
		        'G030001'   /*동의 : G030001*/
		    end   as termsStatus
			,a.customer_sign_dn   as customerSignDn
			,case a.terms_auth_type
				when 'G032001' then a.customer_sign_data
				else
					dec_char_sel(b.customer_phone,
								10,
								'ARIA',
								'spt_customer_service_ars_profile',
								'customer_phone',
								user(),
								connection_id())
			end as customerSignData
			,case a.terms_auth_type when 'G032001' then a.customer_tsa_data else b.ars_txt_no end as customerTsaData
			,a.delete_date        as deleteDate
			,dec_char_sel(c.customer_phone,
							10,
							'ARIA',
							'spt_customer_info_profile',
							'customer_phone',
							user(),
							connection_id())  as customerPhone
        from spt_customer_service_terms_profile a
		inner join (
			SELECT
					a.app_id as app_id,
					a.company_code_id as company_code_id,
					c.company_name_kor_alias as company_name_kor_alias
			FROM 		com_app_view a
        	INNER JOIN 	com_app_info b
        	ON 			a.app_id = b.app_id
        	INNER JOIN 	com_company_profile c
        	ON 			c.company_code_id = a.company_code_id
			AND			c.delete_date is null
        	AND 		c.exposure_yn = 'Y'
			WHERE  		a.app_status = 'G022002'                     /*app 상태 (CA 정보)*/
/*			AND    		b.exposure_yn = 'Y'*/
		) e on e.company_code_id = a.subcompany_code_id
		left join spt_customer_service_ars_profile b on a.customer_reg_no = b.customer_reg_no AND a.terms_reg_no = b.terms_reg_no
		left join spt_customer_info_profile c on a.customer_reg_no = c.customer_reg_no
		where 	a.terms_reg_no = #termsRegNo#
		and     a.customer_reg_no = #customerRegNo#
		limit 0,1
    </select>

    <select id="usr.AppDAO.selectBeforeCommonTermsPubCompanyList" parameterClass="TermsVO" resultClass="AppAccountVO">
        select    a.pubcompany_name    as pubCompanyName
		        , a.terms_pubcompany_reg_no as termsPubCompanyRegNo
		from 	spt_customer_common_terms_pubcompany_profile a
		left join com_company_profile as b
		on 		a.pubcompany_code_id = b.company_code_id
		where 	a.customer_reg_no = #customerRegNo#
		and 	a.terms_reg_no = #termsRegNo#
		order by pubCompanyName
    </select>

    <select id="usr.AppDAO.selectOldServiceRegNo" parameterClass="TermsVO" resultClass="string">
      select service_reg_no as serviceRegNo
		from  spt_customer_service_profile
		where customer_reg_no = #customerRegNo#
		and   app_id = #appId#
		and   terms_reg_no = #termsRegNo#
		and   delete_date is null
    </select>
</sqlMap>